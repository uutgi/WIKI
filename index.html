<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wikipedia Global Research Tool</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --primary: #1a73e8;
            --primary-dark: #1557b0;
            --success: #34a853;
            --warning: #fbbc04;
            --error: #ea4335;
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --text: #202124;
            --text-secondary: #5f6368;
            --border: #dadce0;
            --hover-bg: #f8f9fa;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, #4285f4 100%);
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2rem;
            margin-bottom: 8px;
            font-weight: 600;
        }

        header p {
            opacity: 0.9;
            font-size: 1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Search */
        .search-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }

        .search-box {
            display: flex;
            gap: 12px;
        }

        .search-input {
            flex: 1;
            padding: 16px 20px;
            font-size: 1.1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            outline: none;
            transition: all 0.2s;
        }

        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26,115,232,0.1);
        }

        .search-btn {
            padding: 16px 32px;
            font-size: 1rem;
            font-weight: 600;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
        }

        .search-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .search-btn:disabled {
            background: #9aa0a6;
            cursor: not-allowed;
            transform: none;
        }

        /* Loading */
        .loader {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: none;
        }

        .loading .loader {
            display: block;
        }

        .loading .btn-text {
            display: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Progress */
        .progress-section {
            margin-top: 20px;
            display: none;
        }

        .progress-section.visible {
            display: block;
        }

        .progress-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            border-radius: 3px;
            transition: width 0.3s;
            width: 0%;
        }

        .progress-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-align: center;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .card-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-body {
            padding: 24px;
        }

        /* Wikidata section */
        .wikidata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .wikidata-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px;
            background: var(--hover-bg);
            border-radius: 8px;
        }

        .wikidata-icon {
            width: 36px;
            height: 36px;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .wikidata-content {
            flex: 1;
            min-width: 0;
        }

        .wikidata-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .wikidata-value {
            font-size: 0.95rem;
            color: var(--text);
            word-break: break-word;
        }

        .wikidata-value a {
            color: var(--primary);
            text-decoration: none;
        }

        .wikidata-value a:hover {
            text-decoration: underline;
        }

        /* Image */
        .entity-image {
            width: 100%;
            max-width: 300px;
            border-radius: 8px;
            margin: 0 auto 20px;
            display: block;
        }

        /* Languages section */
        .languages-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .lang-count-badge {
            background: var(--success);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 8px 16px;
            font-size: 0.9rem;
            border: 1px solid var(--border);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn:hover {
            background: var(--hover-bg);
            border-color: var(--primary);
            color: var(--primary);
        }

        .action-btn.primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .action-btn.primary:hover {
            background: var(--primary-dark);
        }

        /* Language items */
        .language-item {
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.2s;
        }

        .language-item:hover {
            border-color: var(--primary);
        }

        .language-item.expanded {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .language-header {
            padding: 16px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 14px;
            background: var(--hover-bg);
            transition: background 0.2s;
        }

        .language-header:hover {
            background: #e8eaed;
        }

        .expand-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .language-item.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .lang-code {
            background: var(--text);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            flex-shrink: 0;
        }

        .lang-info {
            flex: 1;
            min-width: 0;
        }

        .lang-name {
            font-weight: 600;
            color: var(--text);
        }

        .lang-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .char-count {
            font-size: 0.8rem;
            color: var(--text-secondary);
            background: white;
            padding: 4px 10px;
            border-radius: 12px;
            flex-shrink: 0;
        }

        .language-content {
            display: none;
            padding: 20px;
            border-top: 1px solid var(--border);
            background: white;
        }

        .language-item.expanded .language-content {
            display: block;
        }

        .language-summary {
            line-height: 1.8;
            color: var(--text);
            margin-bottom: 16px;
        }

        .language-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .small-btn {
            padding: 6px 12px;
            font-size: 0.85rem;
            border: 1px solid var(--border);
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            color: var(--text);
        }

        .small-btn:hover {
            background: var(--hover-bg);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Filter/Sort */
        .filter-bar {
            display: flex;
            gap: 12px;
            padding: 16px 24px;
            background: var(--hover-bg);
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-bar label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .filter-bar select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
        }

        .filter-bar input[type="text"] {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
            flex: 1;
            min-width: 200px;
        }

        /* No results */
        .no-results {
            text-align: center;
            padding: 60px 20px;
        }

        .no-results h3 {
            font-size: 1.3rem;
            color: var(--error);
            margin-bottom: 10px;
        }

        .no-results p {
            color: var(--text-secondary);
        }

        /* Copy notification */
        .copy-notification {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text);
            color: white;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 0.95rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transition: transform 0.3s;
            z-index: 1000;
        }

        .copy-notification.visible {
            transform: translateX(-50%) translateY(0);
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        footer a {
            color: var(--primary);
            text-decoration: none;
        }

        /* Responsive */
        @media (max-width: 600px) {
            header h1 {
                font-size: 1.5rem;
            }

            .search-box {
                flex-direction: column;
            }

            .search-btn {
                justify-content: center;
            }

            .wikidata-grid {
                grid-template-columns: 1fr;
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-actions {
                width: 100%;
            }

            .action-btn {
                flex: 1;
                justify-content: center;
            }

            .filter-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-bar input[type="text"] {
                min-width: unset;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Wikipedia Global Research Tool</h1>
        <p>Busca un tema y obt√©n informaci√≥n de TODOS los idiomas de Wikipedia. Combina conocimiento de todo el mundo.</p>
    </header>

    <div class="container">
        <!-- Search Section -->
        <div class="search-section">
            <div class="search-box">
                <input
                    type="text"
                    id="searchInput"
                    class="search-input"
                    placeholder="Escribe un nombre, lugar, concepto..."
                    autocomplete="off"
                >
                <button id="searchBtn" class="search-btn">
                    <span class="loader"></span>
                    <span class="btn-text">Buscar en todos los idiomas</span>
                </button>
            </div>
            <div class="progress-section" id="progressSection">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Iniciando b√∫squeda...</div>
            </div>
        </div>

        <!-- Wikidata Section -->
        <div class="card hidden" id="wikidataCard">
            <div class="card-header">
                <h2>üìä Datos Unificados</h2>
                <span style="font-size: 0.85rem; color: var(--text-secondary);">Fuente: Wikidata</span>
            </div>
            <div class="card-body">
                <img id="entityImage" class="entity-image hidden" alt="">
                <div class="wikidata-grid" id="wikidataGrid"></div>
            </div>
        </div>

        <!-- Languages Section -->
        <div class="card hidden" id="languagesCard">
            <div class="card-header">
                <div class="languages-header">
                    <h2>üìö Informaci√≥n por Idioma <span class="lang-count-badge" id="langCountBadge">0</span></h2>
                </div>
                <div class="header-actions">
                    <button class="action-btn" id="expandAllBtn">Expandir todo</button>
                    <button class="action-btn" id="collapseAllBtn">Colapsar todo</button>
                    <button class="action-btn primary" id="copyAllBtn">üìã Copiar todo</button>
                </div>
            </div>
            <div class="filter-bar">
                <label>Ordenar por:</label>
                <select id="sortSelect">
                    <option value="length-desc">M√°s informaci√≥n primero</option>
                    <option value="length-asc">Menos informaci√≥n primero</option>
                    <option value="alpha">Alfab√©tico (idioma)</option>
                </select>
                <input type="text" id="filterInput" placeholder="Filtrar idiomas...">
            </div>
            <div class="card-body" id="languagesList"></div>
        </div>

        <!-- No Results -->
        <div class="card hidden" id="noResultsCard">
            <div class="no-results">
                <h3>No se encontraron resultados</h3>
                <p>Intenta con otro t√©rmino de b√∫squeda. Prueba nombres propios, lugares, conceptos...</p>
            </div>
        </div>
    </div>

    <!-- Copy Notification -->
    <div class="copy-notification" id="copyNotification">
        ‚úì Copiado al portapapeles
    </div>

    <footer>
        <p>Datos de <a href="https://www.wikipedia.org" target="_blank">Wikipedia</a> y <a href="https://www.wikidata.org" target="_blank">Wikidata</a></p>
    </footer>

    <script>
        // ============ STATE ============
        let currentData = null;
        let allLanguagesData = [];

        // ============ DOM ELEMENTS ============
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const progressSection = document.getElementById('progressSection');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const wikidataCard = document.getElementById('wikidataCard');
        const wikidataGrid = document.getElementById('wikidataGrid');
        const entityImage = document.getElementById('entityImage');
        const languagesCard = document.getElementById('languagesCard');
        const langCountBadge = document.getElementById('langCountBadge');
        const languagesList = document.getElementById('languagesList');
        const noResultsCard = document.getElementById('noResultsCard');
        const sortSelect = document.getElementById('sortSelect');
        const filterInput = document.getElementById('filterInput');
        const expandAllBtn = document.getElementById('expandAllBtn');
        const collapseAllBtn = document.getElementById('collapseAllBtn');
        const copyAllBtn = document.getElementById('copyAllBtn');
        const copyNotification = document.getElementById('copyNotification');

        // ============ WIKIDATA PROPERTIES ============
        const WIKIDATA_PROPS = {
            'P31': { label: 'Tipo', icon: 'üè∑Ô∏è' },
            'P569': { label: 'Nacimiento', icon: 'üéÇ' },
            'P570': { label: 'Fallecimiento', icon: '‚úùÔ∏è' },
            'P19': { label: 'Lugar de nacimiento', icon: 'üìç' },
            'P20': { label: 'Lugar de fallecimiento', icon: 'üìç' },
            'P27': { label: 'Nacionalidad', icon: 'üåç' },
            'P106': { label: 'Ocupaci√≥n', icon: 'üíº' },
            'P800': { label: 'Obras notables', icon: 'üìñ' },
            'P26': { label: 'C√≥nyuge', icon: 'üíë' },
            'P22': { label: 'Padre', icon: 'üë®' },
            'P25': { label: 'Madre', icon: 'üë©' },
            'P40': { label: 'Hijos', icon: 'üë∂' },
            'P69': { label: 'Educaci√≥n', icon: 'üéì' },
            'P108': { label: 'Empleador', icon: 'üè¢' },
            'P166': { label: 'Premios', icon: 'üèÜ' },
            'P17': { label: 'Pa√≠s', icon: 'üè≥Ô∏è' },
            'P131': { label: 'Ubicaci√≥n', icon: 'üìç' },
            'P625': { label: 'Coordenadas', icon: 'üó∫Ô∏è' },
            'P571': { label: 'Fecha de fundaci√≥n', icon: 'üìÖ' },
            'P112': { label: 'Fundador', icon: 'üë§' },
            'P159': { label: 'Sede', icon: 'üèõÔ∏è' },
            'P856': { label: 'Sitio web', icon: 'üåê' },
            'P18': { label: 'Imagen', icon: 'üñºÔ∏è' }
        };

        // ============ MAIN SEARCH ============
        async function search() {
            const term = searchInput.value.trim();
            if (!term) return;

            setLoading(true);
            hideAllCards();
            showProgress();

            try {
                // Step 1: Search and find the entity
                updateProgress(5, 'Buscando art√≠culo...');
                const searchResult = await searchWikipedia(term);

                if (!searchResult) {
                    showNoResults();
                    return;
                }

                // Step 2: Get Wikidata entity
                updateProgress(15, 'Obteniendo datos de Wikidata...');
                const wikidataId = await getWikidataId(searchResult.lang, searchResult.title);

                let wikidataEntity = null;
                if (wikidataId) {
                    wikidataEntity = await getWikidataEntity(wikidataId);
                }

                // Step 3: Get all available languages
                updateProgress(25, 'Descubriendo idiomas disponibles...');
                const langLinks = await getLanguageLinks(searchResult.lang, searchResult.title);

                // Add the original language
                langLinks[searchResult.lang] = searchResult.title;

                const totalLangs = Object.keys(langLinks).length;
                updateProgress(30, `Encontrados ${totalLangs} idiomas. Cargando contenido...`);

                // Step 4: Fetch summaries from all languages in parallel batches
                const langEntries = Object.entries(langLinks);
                const batchSize = 10;
                const allResults = [];

                for (let i = 0; i < langEntries.length; i += batchSize) {
                    const batch = langEntries.slice(i, i + batchSize);
                    const batchResults = await Promise.all(
                        batch.map(([lang, title]) => fetchSummary(lang, title))
                    );
                    allResults.push(...batchResults);

                    const progress = 30 + Math.round((i / langEntries.length) * 60);
                    updateProgress(progress, `Cargando idiomas... ${Math.min(i + batchSize, langEntries.length)}/${totalLangs}`);
                }

                // Filter out failed requests
                allLanguagesData = allResults.filter(r => r && r.summary);

                updateProgress(95, 'Procesando resultados...');

                // Step 5: Display results
                if (allLanguagesData.length === 0) {
                    showNoResults();
                    return;
                }

                currentData = {
                    term: term,
                    wikidata: wikidataEntity,
                    languages: allLanguagesData
                };

                displayWikidata(wikidataEntity);
                displayLanguages(allLanguagesData);

                updateProgress(100, '¬°Completado!');

                setTimeout(() => {
                    hideProgress();
                }, 500);

            } catch (error) {
                console.error('Search error:', error);
                showNoResults();
            } finally {
                setLoading(false);
            }
        }

        // ============ WIKIPEDIA API ============
        async function searchWikipedia(term) {
            // Try multiple languages to find the article
            const tryLanguages = ['en', 'es', 'fr', 'de', 'it', 'pt', 'ru', 'ja', 'zh'];
            const variations = [term, term.toLowerCase(), titleCase(term)];

            for (const variant of variations) {
                for (const lang of tryLanguages) {
                    try {
                        const url = `https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(variant)}`;
                        const response = await fetch(url);

                        if (response.ok) {
                            const data = await response.json();
                            if (data.extract) {
                                return { lang, title: data.title };
                            }
                        }
                    } catch (e) {
                        continue;
                    }
                }
            }
            return null;
        }

        async function getLanguageLinks(lang, title) {
            const url = `https://${lang}.wikipedia.org/w/api.php?` + new URLSearchParams({
                action: 'query',
                titles: title,
                prop: 'langlinks',
                lllimit: '500',
                format: 'json',
                origin: '*'
            });

            try {
                const response = await fetch(url);
                const data = await response.json();
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                const langlinks = pages[pageId]?.langlinks || [];

                const result = {};
                langlinks.forEach(ll => {
                    result[ll.lang] = ll['*'];
                });
                return result;
            } catch (error) {
                return {};
            }
        }

        async function fetchSummary(lang, title) {
            try {
                const url = `https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
                const response = await fetch(url);

                if (!response.ok) return null;

                const data = await response.json();

                return {
                    lang: lang,
                    langName: getLanguageName(lang),
                    title: data.title,
                    summary: data.extract || '',
                    url: data.content_urls?.desktop?.page || `https://${lang}.wikipedia.org/wiki/${encodeURIComponent(title)}`,
                    charCount: (data.extract || '').length
                };
            } catch (error) {
                return null;
            }
        }

        // ============ WIKIDATA API ============
        async function getWikidataId(lang, title) {
            const url = `https://${lang}.wikipedia.org/w/api.php?` + new URLSearchParams({
                action: 'query',
                titles: title,
                prop: 'pageprops',
                format: 'json',
                origin: '*'
            });

            try {
                const response = await fetch(url);
                const data = await response.json();
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                return pages[pageId]?.pageprops?.wikibase_item || null;
            } catch (error) {
                return null;
            }
        }

        async function getWikidataEntity(qid) {
            const url = `https://www.wikidata.org/w/api.php?` + new URLSearchParams({
                action: 'wbgetentities',
                ids: qid,
                props: 'labels|descriptions|claims',
                languages: 'es|en',
                format: 'json',
                origin: '*'
            });

            try {
                const response = await fetch(url);
                const data = await response.json();
                return data.entities?.[qid] || null;
            } catch (error) {
                return null;
            }
        }

        function extractWikidataValue(claim) {
            if (!claim || !claim[0]) return null;

            const mainsnak = claim[0].mainsnak;
            if (!mainsnak.datavalue) return null;

            const value = mainsnak.datavalue.value;
            const type = mainsnak.datavalue.type;

            switch (type) {
                case 'string':
                    return value;
                case 'time':
                    return formatWikidataDate(value.time);
                case 'wikibase-entityid':
                    return { id: value.id, needsLabel: true };
                case 'quantity':
                    return value.amount;
                case 'globecoordinate':
                    return `${value.latitude.toFixed(4)}, ${value.longitude.toFixed(4)}`;
                case 'monolingualtext':
                    return value.text;
                default:
                    return null;
            }
        }

        function formatWikidataDate(timeStr) {
            // Format: +1452-04-15T00:00:00Z
            const match = timeStr.match(/([+-]?\d+)-(\d{2})-(\d{2})/);
            if (match) {
                const year = parseInt(match[1]);
                const month = parseInt(match[2]);
                const day = parseInt(match[3]);

                if (month === 0 && day === 0) return `${Math.abs(year)}${year < 0 ? ' a.C.' : ''}`;
                if (day === 0) return `${getMonthName(month)} ${Math.abs(year)}${year < 0 ? ' a.C.' : ''}`;
                return `${day} ${getMonthName(month)} ${Math.abs(year)}${year < 0 ? ' a.C.' : ''}`;
            }
            return timeStr;
        }

        function getMonthName(month) {
            const months = ['', 'enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio',
                           'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
            return months[month] || '';
        }

        async function resolveWikidataLabels(ids) {
            if (ids.length === 0) return {};

            const url = `https://www.wikidata.org/w/api.php?` + new URLSearchParams({
                action: 'wbgetentities',
                ids: ids.join('|'),
                props: 'labels',
                languages: 'es|en',
                format: 'json',
                origin: '*'
            });

            try {
                const response = await fetch(url);
                const data = await response.json();
                const labels = {};

                for (const [id, entity] of Object.entries(data.entities || {})) {
                    labels[id] = entity.labels?.es?.value || entity.labels?.en?.value || id;
                }

                return labels;
            } catch (error) {
                return {};
            }
        }

        // ============ DISPLAY FUNCTIONS ============
        async function displayWikidata(entity) {
            if (!entity) {
                wikidataCard.classList.add('hidden');
                return;
            }

            const claims = entity.claims || {};
            const items = [];
            const idsToResolve = [];

            // Extract values and collect IDs that need label resolution
            for (const [prop, config] of Object.entries(WIKIDATA_PROPS)) {
                if (claims[prop]) {
                    const value = extractWikidataValue(claims[prop]);
                    if (value) {
                        if (value.needsLabel) {
                            idsToResolve.push(value.id);
                            items.push({ prop, config, value: value.id, needsLabel: true });
                        } else {
                            items.push({ prop, config, value, needsLabel: false });
                        }
                    }
                }
            }

            // Resolve entity labels
            const labels = await resolveWikidataLabels(idsToResolve);

            // Check for image
            if (claims['P18']) {
                const imageName = extractWikidataValue(claims['P18']);
                if (imageName) {
                    const imageUrl = getCommonsImageUrl(imageName);
                    entityImage.src = imageUrl;
                    entityImage.classList.remove('hidden');
                }
            } else {
                entityImage.classList.add('hidden');
            }

            // Build grid
            wikidataGrid.innerHTML = items
                .filter(item => item.prop !== 'P18') // Exclude image from grid
                .map(item => {
                    const displayValue = item.needsLabel ? (labels[item.value] || item.value) : item.value;
                    const isUrl = typeof displayValue === 'string' && displayValue.startsWith('http');

                    return `
                        <div class="wikidata-item">
                            <div class="wikidata-icon">${item.config.icon}</div>
                            <div class="wikidata-content">
                                <div class="wikidata-label">${item.config.label}</div>
                                <div class="wikidata-value">
                                    ${isUrl ? `<a href="${displayValue}" target="_blank">${displayValue}</a>` : displayValue}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            wikidataCard.classList.remove('hidden');
        }

        function getCommonsImageUrl(filename) {
            // Generate Wikimedia Commons thumbnail URL
            const encoded = encodeURIComponent(filename.replace(/ /g, '_'));
            return `https://commons.wikimedia.org/wiki/Special:FilePath/${encoded}?width=300`;
        }

        function displayLanguages(languages) {
            langCountBadge.textContent = languages.length;
            renderLanguageList(languages);
            languagesCard.classList.remove('hidden');
        }

        function renderLanguageList(languages) {
            languagesList.innerHTML = languages.map((lang, index) => `
                <div class="language-item" data-index="${index}">
                    <div class="language-header" onclick="toggleLanguage(${index})">
                        <div class="expand-icon">‚ñº</div>
                        <span class="lang-code">${lang.lang}</span>
                        <div class="lang-info">
                            <div class="lang-name">${lang.langName}</div>
                            <div class="lang-title">${lang.title}</div>
                        </div>
                        <span class="char-count">${formatNumber(lang.charCount)} caracteres</span>
                    </div>
                    <div class="language-content">
                        <p class="language-summary">${lang.summary}</p>
                        <div class="language-actions">
                            <a href="${lang.url}" target="_blank" class="small-btn">üîó Ver en Wikipedia</a>
                            <button class="small-btn" onclick="copyText('${escapeForJs(lang.summary)}', event)">üìã Copiar texto</button>
                            <button class="small-btn" onclick="copyText('${escapeForJs(lang.title)}', event)">üìã Copiar t√≠tulo</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleLanguage(index) {
            const item = document.querySelector(`.language-item[data-index="${index}"]`);
            item.classList.toggle('expanded');
        }

        // ============ UTILITY FUNCTIONS ============
        function getLanguageName(code) {
            const names = {
                'en': 'English', 'es': 'Espa√±ol', 'fr': 'Fran√ßais', 'de': 'Deutsch',
                'it': 'Italiano', 'pt': 'Portugu√™s', 'ru': '–†—É—Å—Å–∫–∏–π', 'ja': 'Êó•Êú¨Ë™û',
                'zh': '‰∏≠Êñá', 'ar': 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', 'ko': 'ÌïúÍµ≠Ïñ¥', 'nl': 'Nederlands',
                'pl': 'Polski', 'sv': 'Svenska', 'uk': '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞', 'vi': 'Ti·∫øng Vi·ªát',
                'ca': 'Catal√†', 'fi': 'Suomi', 'cs': 'ƒåe≈°tina', 'ro': 'Rom√¢nƒÉ',
                'hu': 'Magyar', 'el': 'ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨', 'da': 'Dansk', 'he': '◊¢◊ë◊®◊ô◊™',
                'no': 'Norsk', 'id': 'Bahasa Indonesia', 'th': '‡πÑ‡∏ó‡∏¢', 'tr': 'T√ºrk√ße',
                'fa': 'ŸÅÿßÿ±ÿ≥€å', 'hi': '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä', 'bn': '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ', 'la': 'Latina',
                'eu': 'Euskara', 'gl': 'Galego', 'hr': 'Hrvatski', 'sk': 'Slovenƒçina',
                'sr': '–°—Ä–ø—Å–∫–∏', 'bg': '–ë—ä–ª–≥–∞—Ä—Å–∫–∏', 'lt': 'Lietuvi≈≥', 'sl': 'Sloven≈°ƒçina',
                'et': 'Eesti', 'lv': 'Latvie≈°u', 'ms': 'Bahasa Melayu', 'ta': '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç',
                'te': '‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å', 'ml': '‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç', 'mr': '‡§Æ‡§∞‡§æ‡§†‡•Ä', 'kn': '‡≤ï‡≤®‡≥ç‡≤®‡≤°',
                'gu': '‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä', 'pa': '‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä', 'or': '‡¨ì‡¨°‡¨º‡¨ø‡¨Ü', 'as': '‡¶Ö‡¶∏‡¶Æ‡ßÄ‡¶Ø‡¶º‡¶æ',
                'ne': '‡§®‡•á‡§™‡§æ‡§≤‡•Ä', 'si': '‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω', 'my': '·Äô·Äº·Äî·Ä∫·Äô·Ä¨', 'km': '·ûó·û∂·ûü·û∂·ûÅ·üí·ûò·üÇ·ûö',
                'ka': '·É•·Éê·É†·Éó·É£·Éö·Éò', 'hy': '’Ä’°’µ’•÷Ädelays', 'az': 'Az…ôrbaycan', 'uz': 'O ªzbek',
                'kk': '“ö–∞–∑–∞“õ', 'ky': '–ö—ã—Ä–≥—ã–∑', 'tg': '–¢–æ“∑–∏–∫”£', 'mn': '–ú–æ–Ω–≥–æ–ª',
                'af': 'Afrikaans', 'sw': 'Kiswahili', 'yo': 'Yor√πb√°', 'zu': 'Zulu',
                'simple': 'Simple English', 'war': 'Winaray', 'ceb': 'Cebuano',
                'min': 'Minangkabau', 'jv': 'Basa Jawa', 'su': 'Basa Sunda',
                'eo': 'Esperanto', 'cy': 'Cymraeg', 'ga': 'Gaeilge', 'gd': 'G√†idhlig',
                'br': 'Brezhoneg', 'oc': 'Occitan', 'an': 'Aragon√©s', 'ast': 'Asturianu',
                'nds': 'Plattd√º√ºtsch', 'lb': 'L√´tzebuergesch', 'fy': 'Frysk',
                'is': '√çslenska', 'fo': 'F√∏royskt', 'nn': 'Nynorsk', 'nb': 'Bokm√•l',
                'sh': 'Srpskohrvatski', 'bs': 'Bosanski', 'mk': '–ú–∞–∫–µ–¥–æ–Ω—Å–∫–∏',
                'sq': 'Shqip', 'be': '–ë–µ–ª–∞—Ä—É—Å–∫–∞—è', 'tt': '–¢–∞—Ç–∞—Ä', 'ba': '–ë–∞—à“°–æ—Ä—Ç',
                'cv': '–ß”ë–≤–∞—à', 'ce': '–ù–æ—Ö—á–∏–π–Ω', 'sco': 'Scots', 'nap': 'Napulitano',
                'vec': 'V√®neto', 'lmo': 'Lombard', 'pms': 'Piemont√®is', 'scn': 'Sicilianu',
                'wa': 'Walon', 'als': 'Alemannisch', 'bar': 'Boarisch', 'frr': 'Nordfriisk',
                'li': 'Limburgs', 'vls': 'West-Vlams', 'zea': 'Ze√™uws'
            };
            return names[code] || code.toUpperCase();
        }

        function titleCase(str) {
            return str.replace(/\w\S*/g, txt =>
                txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
            );
        }

        function formatNumber(num) {
            return num.toLocaleString();
        }

        function escapeForJs(str) {
            return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/\n/g, '\\n');
        }

        function setLoading(loading) {
            searchBtn.disabled = loading;
            searchBtn.classList.toggle('loading', loading);
        }

        function showProgress() {
            progressSection.classList.add('visible');
        }

        function hideProgress() {
            progressSection.classList.remove('visible');
        }

        function updateProgress(percent, text) {
            progressFill.style.width = `${percent}%`;
            progressText.textContent = text;
        }

        function hideAllCards() {
            wikidataCard.classList.add('hidden');
            languagesCard.classList.add('hidden');
            noResultsCard.classList.add('hidden');
        }

        function showNoResults() {
            noResultsCard.classList.remove('hidden');
            hideProgress();
            setLoading(false);
        }

        function showCopyNotification(text = '‚úì Copiado al portapapeles') {
            copyNotification.textContent = text;
            copyNotification.classList.add('visible');
            setTimeout(() => {
                copyNotification.classList.remove('visible');
            }, 2000);
        }

        // ============ ACTIONS ============
        function copyText(text, event) {
            if (event) event.stopPropagation();
            navigator.clipboard.writeText(text).then(() => {
                showCopyNotification();
            });
        }

        function copyAllContent() {
            if (!currentData) return;

            let content = `# ${currentData.term}\n\n`;

            // Add Wikidata info
            if (currentData.wikidata) {
                content += `## Datos Unificados (Wikidata)\n\n`;
                const description = currentData.wikidata.descriptions?.es?.value ||
                                   currentData.wikidata.descriptions?.en?.value || '';
                if (description) content += `${description}\n\n`;
            }

            // Add all language summaries
            content += `## Informaci√≥n por Idioma (${currentData.languages.length} idiomas)\n\n`;

            currentData.languages.forEach(lang => {
                content += `### ${lang.langName} (${lang.lang})\n`;
                content += `**T√≠tulo:** ${lang.title}\n\n`;
                content += `${lang.summary}\n\n`;
                content += `---\n\n`;
            });

            navigator.clipboard.writeText(content).then(() => {
                showCopyNotification(`‚úì Copiado: ${currentData.languages.length} idiomas`);
            });
        }

        function expandAll() {
            document.querySelectorAll('.language-item').forEach(item => {
                item.classList.add('expanded');
            });
        }

        function collapseAll() {
            document.querySelectorAll('.language-item').forEach(item => {
                item.classList.remove('expanded');
            });
        }

        function sortLanguages() {
            const sortBy = sortSelect.value;
            let sorted = [...allLanguagesData];

            switch (sortBy) {
                case 'length-desc':
                    sorted.sort((a, b) => b.charCount - a.charCount);
                    break;
                case 'length-asc':
                    sorted.sort((a, b) => a.charCount - b.charCount);
                    break;
                case 'alpha':
                    sorted.sort((a, b) => a.langName.localeCompare(b.langName));
                    break;
            }

            renderLanguageList(sorted);
        }

        function filterLanguages() {
            const filter = filterInput.value.toLowerCase();
            document.querySelectorAll('.language-item').forEach(item => {
                const langName = item.querySelector('.lang-name').textContent.toLowerCase();
                const langCode = item.querySelector('.lang-code').textContent.toLowerCase();
                const title = item.querySelector('.lang-title').textContent.toLowerCase();

                const matches = langName.includes(filter) ||
                               langCode.includes(filter) ||
                               title.includes(filter);

                item.style.display = matches ? '' : 'none';
            });
        }

        // ============ EVENT LISTENERS ============
        searchBtn.addEventListener('click', search);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') search();
        });
        sortSelect.addEventListener('change', sortLanguages);
        filterInput.addEventListener('input', filterLanguages);
        expandAllBtn.addEventListener('click', expandAll);
        collapseAllBtn.addEventListener('click', collapseAll);
        copyAllBtn.addEventListener('click', copyAllContent);

        // Focus search on load
        searchInput.focus();
    </script>
</body>
</html>
