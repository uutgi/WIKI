<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wikipedia Global Research Tool</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --primary: #1a73e8;
            --primary-dark: #1557b0;
            --success: #34a853;
            --warning: #fbbc04;
            --error: #ea4335;
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --text: #202124;
            --text-secondary: #5f6368;
            --border: #dadce0;
            --hover-bg: #f8f9fa;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, #4285f4 100%);
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2rem;
            margin-bottom: 8px;
            font-weight: 600;
        }

        header p {
            opacity: 0.9;
            font-size: 1rem;
            max-width: 700px;
            margin: 0 auto;
        }

        .search-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }

        .search-box {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 16px 20px;
            font-size: 1.1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            outline: none;
            transition: all 0.2s;
        }

        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26,115,232,0.1);
        }

        .btn {
            padding: 16px 28px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #2d9249;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #9aa0a6;
            cursor: not-allowed;
            transform: none;
        }

        .loader {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: none;
        }

        .loading .loader {
            display: block;
        }

        .loading .btn-text {
            display: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-section {
            margin-top: 20px;
            display: none;
        }

        .progress-section.visible {
            display: block;
        }

        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            border-radius: 4px;
            transition: width 0.3s;
            width: 0%;
        }

        .progress-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .card-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-body {
            padding: 24px;
        }

        .wikidata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .wikidata-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px;
            background: var(--hover-bg);
            border-radius: 8px;
        }

        .wikidata-icon {
            width: 36px;
            height: 36px;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .wikidata-content {
            flex: 1;
            min-width: 0;
        }

        .wikidata-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .wikidata-value {
            font-size: 0.95rem;
            color: var(--text);
            word-break: break-word;
        }

        .entity-image {
            width: 100%;
            max-width: 300px;
            border-radius: 8px;
            margin: 0 auto 20px;
            display: block;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab {
            padding: 14px 24px;
            font-size: 1rem;
            font-weight: 500;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab:hover {
            color: var(--primary);
            background: var(--hover-bg);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .unified-section {
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .unified-section-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, #4285f4 100%);
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .unified-section-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lang-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .lang-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .unified-section-content {
            display: none;
            padding: 0;
        }

        .unified-section.expanded .unified-section-content {
            display: block;
        }

        .unified-section.expanded .expand-indicator {
            transform: rotate(180deg);
        }

        .expand-indicator {
            transition: transform 0.2s;
        }

        .lang-content-item {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .lang-content-item:last-child {
            border-bottom: none;
        }

        .lang-content-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .lang-flag {
            background: var(--text);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .lang-content-title {
            font-weight: 600;
            color: var(--primary);
        }

        .lang-content-text {
            line-height: 1.8;
            color: var(--text);
        }

        .lang-content-text p {
            margin-bottom: 12px;
        }

        .lang-count-badge {
            background: var(--success);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 8px 16px;
            font-size: 0.9rem;
            border: 1px solid var(--border);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn:hover {
            background: var(--hover-bg);
            border-color: var(--primary);
            color: var(--primary);
        }

        .action-btn.primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .language-item {
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .language-header {
            padding: 16px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 14px;
            background: var(--hover-bg);
            transition: background 0.2s;
        }

        .language-header:hover {
            background: #e8eaed;
        }

        .expand-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .language-item.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .lang-code {
            background: var(--text);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .lang-info {
            flex: 1;
            min-width: 0;
        }

        .lang-name {
            font-weight: 600;
            color: var(--text);
        }

        .lang-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .section-count {
            font-size: 0.8rem;
            color: var(--text-secondary);
            background: white;
            padding: 4px 10px;
            border-radius: 12px;
        }

        .language-content {
            display: none;
            padding: 20px;
            border-top: 1px solid var(--border);
            background: white;
        }

        .language-item.expanded .language-content {
            display: block;
        }

        .section-item {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .section-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-text {
            line-height: 1.8;
            color: var(--text);
        }

        .filter-bar {
            display: flex;
            gap: 12px;
            padding: 16px 24px;
            background: var(--hover-bg);
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-bar label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .filter-bar select, .filter-bar input[type="text"] {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
        }

        .filter-bar input[type="text"] {
            flex: 1;
            min-width: 200px;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
        }

        .no-results h3 {
            font-size: 1.3rem;
            color: var(--error);
            margin-bottom: 10px;
        }

        .copy-notification {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text);
            color: white;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 0.95rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transition: transform 0.3s;
            z-index: 1000;
        }

        .copy-notification.visible {
            transform: translateX(-50%) translateY(0);
        }

        .hidden {
            display: none !important;
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            padding: 16px 24px;
            background: var(--hover-bg);
            border-radius: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        footer {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        footer a {
            color: var(--primary);
            text-decoration: none;
        }

        @media (max-width: 600px) {
            header h1 { font-size: 1.5rem; }
            .search-box { flex-direction: column; }
            .btn { width: 100%; justify-content: center; }
            .wikidata-grid { grid-template-columns: 1fr; }
            .tabs { flex-wrap: nowrap; }
            .tab { padding: 12px 16px; font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Wikipedia Global Research Tool</h1>
        <p>Busca un tema y recopila TODA la informaci√≥n de TODOS los idiomas. Unifica campos para obtener la descripci√≥n m√°s completa posible.</p>
    </header>

    <div class="container">
        <div class="search-section">
            <div class="search-box">
                <input type="text" id="searchInput" class="search-input" placeholder="Escribe un nombre, lugar, concepto..." autocomplete="off">
                <button id="searchBtn" class="btn btn-primary">
                    <span class="loader"></span>
                    <span class="btn-text">Buscar</span>
                </button>
                <button id="fullAnalysisBtn" class="btn btn-success hidden">
                    <span class="loader"></span>
                    <span class="btn-text">An√°lisis Completo</span>
                </button>
            </div>
            <div class="progress-section" id="progressSection">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Iniciando b√∫squeda...</div>
            </div>
        </div>

        <div class="card hidden" id="wikidataCard">
            <div class="card-header">
                <h2>üìä Datos Unificados</h2>
                <span style="font-size: 0.85rem; color: var(--text-secondary);">Fuente: Wikidata</span>
            </div>
            <div class="card-body">
                <img id="entityImage" class="entity-image hidden" alt="">
                <div class="wikidata-grid" id="wikidataGrid"></div>
            </div>
        </div>

        <div class="card hidden" id="resultsCard">
            <div class="card-header">
                <h2>üìö Resultados <span class="lang-count-badge" id="langCountBadge">0</span></h2>
                <div class="header-actions">
                    <button class="action-btn" id="expandAllBtn">Expandir todo</button>
                    <button class="action-btn" id="collapseAllBtn">Colapsar todo</button>
                    <button class="action-btn primary" id="copyAllBtn">üìã Copiar todo</button>
                </div>
            </div>

            <div class="tabs" id="tabsContainer">
                <button class="tab active" data-tab="unified">Vista Unificada</button>
                <button class="tab" data-tab="by-language">Por Idioma</button>
            </div>

            <div id="statsBar" class="stats-bar hidden">
                <div class="stat-item">
                    <span class="stat-value" id="statLanguages">0</span>
                    <span class="stat-label">Idiomas</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="statSections">0</span>
                    <span class="stat-label">Secciones √∫nicas</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="statChars">0</span>
                    <span class="stat-label">Caracteres totales</span>
                </div>
            </div>

            <div class="tab-content active" id="unifiedTab">
                <div class="card-body" id="unifiedContent">
                    <p style="color: var(--text-secondary); text-align: center; padding: 40px;">
                        Haz clic en <strong>"An√°lisis Completo"</strong> para obtener todas las secciones de todos los idiomas unificadas.
                    </p>
                </div>
            </div>

            <div class="tab-content" id="byLanguageTab">
                <div class="filter-bar">
                    <label>Ordenar:</label>
                    <select id="sortSelect">
                        <option value="sections-desc">M√°s secciones primero</option>
                        <option value="length-desc">M√°s contenido primero</option>
                        <option value="alpha">Alfab√©tico</option>
                    </select>
                    <input type="text" id="filterInput" placeholder="Filtrar idiomas...">
                </div>
                <div class="card-body" id="languagesList"></div>
            </div>
        </div>

        <div class="card hidden" id="noResultsCard">
            <div class="no-results">
                <h3>No se encontraron resultados</h3>
                <p>Intenta con otro t√©rmino de b√∫squeda.</p>
            </div>
        </div>
    </div>

    <div class="copy-notification" id="copyNotification">‚úì Copiado al portapapeles</div>

    <footer>
        <p>Datos de <a href="https://www.wikipedia.org" target="_blank">Wikipedia</a> y <a href="https://www.wikidata.org" target="_blank">Wikidata</a></p>
    </footer>

    <script>
        // ============ ALLOWED LANGUAGES (Latin alphabet + Greek) ============
        const ALLOWED_LANGUAGES = new Set([
            // Major Western languages
            'en', 'es', 'fr', 'de', 'it', 'pt', 'nl', 'pl', 'sv', 'da', 'no', 'fi',
            // Romance languages
            'ca', 'gl', 'ro', 'oc', 'an', 'ast', 'ext', 'fur', 'lad', 'lij', 'lmo',
            'nap', 'pms', 'rm', 'sc', 'scn', 'vec', 'wa',
            // Germanic languages
            'af', 'als', 'bar', 'cy', 'fy', 'gd', 'is', 'lb', 'li', 'nds', 'nn', 'sco', 'vls',
            // Celtic languages
            'br', 'ga', 'gv', 'kw',
            // Baltic languages
            'lt', 'lv',
            // Slavic with Latin script
            'cs', 'sk', 'sl', 'hr', 'bs', 'pl',
            // Finno-Ugric with Latin script
            'et', 'hu',
            // Other Latin-script languages
            'eu', 'mt', 'sq', 'tr', 'az', 'uz', 'tk', 'sw', 'id', 'ms', 'tl', 'ceb', 'vi',
            'eo', 'io', 'ia', 'ie', 'vo', 'la',
            // Simple English
            'simple',
            // Greek (exception requested by user)
            'el'
        ]);

        function isAllowedLanguage(code) {
            return ALLOWED_LANGUAGES.has(code);
        }

        // ============ STATE ============
        let currentData = null;
        let fullAnalysisData = null;
        let allLanguagesData = [];

        // ============ DOM ELEMENTS ============
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const fullAnalysisBtn = document.getElementById('fullAnalysisBtn');
        const progressSection = document.getElementById('progressSection');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const wikidataCard = document.getElementById('wikidataCard');
        const wikidataGrid = document.getElementById('wikidataGrid');
        const entityImage = document.getElementById('entityImage');
        const resultsCard = document.getElementById('resultsCard');
        const langCountBadge = document.getElementById('langCountBadge');
        const unifiedContent = document.getElementById('unifiedContent');
        const languagesList = document.getElementById('languagesList');
        const noResultsCard = document.getElementById('noResultsCard');
        const sortSelect = document.getElementById('sortSelect');
        const filterInput = document.getElementById('filterInput');
        const copyNotification = document.getElementById('copyNotification');
        const statsBar = document.getElementById('statsBar');

        // ============ SECTION MAPPING ============
        const SECTION_KEYWORDS = {
            'biography': ['biography', 'biograf√≠a', 'biographie', 'biografie', 'biografia', 'Œ≤ŒπŒøŒ≥œÅŒ±œÜŒØŒ±', 'vida', 'life', 'leben', 'vie'],
            'early_life': ['early life', 'primeros a√±os', 'infancia', 'childhood', 'juventud', 'youth', 'enfance', 'kindheit', 'early years', 'nacimiento'],
            'career': ['career', 'carrera', 'carri√®re', 'karriere', 'carriera', 'trayectoria', 'professional life', 'trabajo'],
            'works': ['works', 'obras', '≈ìuvres', 'werke', 'opere', 'trabajos', 'publications', 'publicaciones', 'bibliography', 'bibliograf√≠a', 'filmography', 'filmograf√≠a', 'discography', 'discograf√≠a'],
            'legacy': ['legacy', 'legado', 'h√©ritage', 'verm√§chtnis', 'eredit√†', 'influence', 'influencia', 'impact', 'impacto'],
            'death': ['death', 'muerte', 'mort', 'tod', 'morte', 'fallecimiento', 'deceso'],
            'awards': ['awards', 'premios', 'prix', 'auszeichnungen', 'premi', 'honors', 'honores', 'recognition', 'reconocimientos'],
            'personal_life': ['personal life', 'vida personal', 'vie priv√©e', 'privatleben', 'vita privata', 'family', 'familia', 'famille'],
            'education': ['education', 'educaci√≥n', '√©ducation', 'bildung', 'istruzione', 'formaci√≥n', 'studies', 'estudios'],
            'history': ['history', 'historia', 'histoire', 'geschichte', 'storia', 'historical'],
            'geography': ['geography', 'geograf√≠a', 'g√©ographie', 'geographie', 'geografia', 'location', 'ubicaci√≥n', 'localizaci√≥n'],
            'architecture': ['architecture', 'arquitectura', 'architektur', 'architettura', 'construction', 'construcci√≥n', 'building', 'edificio'],
            'culture': ['culture', 'cultura', 'kultur', 'traditions', 'tradiciones', 'customs', 'costumbres'],
            'economy': ['economy', 'econom√≠a', '√©conomie', 'wirtschaft', 'economia', 'economic'],
            'politics': ['politics', 'pol√≠tica', 'politique', 'politik', 'politica', 'government', 'gobierno'],
            'demographics': ['demographics', 'demograf√≠a', 'd√©mographie', 'demografie', 'population', 'poblaci√≥n'],
            'references': ['references', 'referencias', 'r√©f√©rences', 'einzelnachweise', 'riferimenti', 'notes', 'notas'],
            'see_also': ['see also', 'v√©ase tambi√©n', 'voir aussi', 'siehe auch', 'vedi anche', 'related'],
            'external_links': ['external links', 'enlaces externos', 'liens externes', 'weblinks', 'collegamenti esterni']
        };

        const SECTION_LABELS = {
            'biography': 'üìú Biograf√≠a',
            'early_life': 'üë∂ Primeros a√±os',
            'career': 'üíº Carrera',
            'works': 'üìö Obras',
            'legacy': 'üèõÔ∏è Legado',
            'death': '‚úùÔ∏è Fallecimiento',
            'awards': 'üèÜ Premios',
            'personal_life': 'üë®‚Äçüë©‚Äçüëß Vida personal',
            'education': 'üéì Educaci√≥n',
            'history': 'üìñ Historia',
            'geography': 'üó∫Ô∏è Geograf√≠a',
            'architecture': 'üèóÔ∏è Arquitectura',
            'culture': 'üé≠ Cultura',
            'economy': 'üí∞ Econom√≠a',
            'politics': 'üèõÔ∏è Pol√≠tica',
            'demographics': 'üë• Demograf√≠a',
            'references': 'üìë Referencias',
            'see_also': 'üîó Ver tambi√©n',
            'external_links': 'üåê Enlaces externos',
            'other': 'üìÑ Otros'
        };

        // ============ WIKIDATA PROPERTIES ============
        const WIKIDATA_PROPS = {
            'P31': { label: 'Tipo', icon: 'üè∑Ô∏è' },
            'P569': { label: 'Nacimiento', icon: 'üéÇ' },
            'P570': { label: 'Fallecimiento', icon: '‚úùÔ∏è' },
            'P19': { label: 'Lugar de nacimiento', icon: 'üìç' },
            'P20': { label: 'Lugar de fallecimiento', icon: 'üìç' },
            'P27': { label: 'Nacionalidad', icon: 'üåç' },
            'P106': { label: 'Ocupaci√≥n', icon: 'üíº' },
            'P800': { label: 'Obras notables', icon: 'üìñ' },
            'P166': { label: 'Premios', icon: 'üèÜ' },
            'P17': { label: 'Pa√≠s', icon: 'üè≥Ô∏è' },
            'P131': { label: 'Ubicaci√≥n', icon: 'üìç' },
            'P571': { label: 'Fundaci√≥n', icon: 'üìÖ' },
            'P856': { label: 'Sitio web', icon: 'üåê' },
            'P18': { label: 'Imagen', icon: 'üñºÔ∏è' }
        };

        // ============ MAIN SEARCH ============
        async function search() {
            const term = searchInput.value.trim();
            if (!term) return;

            setLoading(searchBtn, true);
            hideAllCards();
            showProgress();
            fullAnalysisBtn.classList.add('hidden');

            try {
                updateProgress(5, 'Buscando art√≠culo...');
                const searchResult = await searchWikipedia(term);

                if (!searchResult) {
                    showNoResults();
                    return;
                }

                updateProgress(15, 'Obteniendo datos de Wikidata...');
                const wikidataId = await getWikidataId(searchResult.lang, searchResult.title);
                let wikidataEntity = wikidataId ? await getWikidataEntity(wikidataId) : null;

                updateProgress(25, 'Descubriendo idiomas...');
                const langLinks = await getLanguageLinks(searchResult.lang, searchResult.title);
                langLinks[searchResult.lang] = searchResult.title;

                const totalLangs = Object.keys(langLinks).length;
                updateProgress(30, `Encontrados ${totalLangs} idiomas. Cargando res√∫menes...`);

                const langEntries = Object.entries(langLinks);
                const batchSize = 15;
                const allResults = [];

                for (let i = 0; i < langEntries.length; i += batchSize) {
                    const batch = langEntries.slice(i, i + batchSize);
                    const batchResults = await Promise.all(
                        batch.map(([lang, title]) => fetchSummary(lang, title))
                    );
                    allResults.push(...batchResults);
                    const progress = 30 + Math.round((i / langEntries.length) * 60);
                    updateProgress(progress, `Cargando res√∫menes... ${Math.min(i + batchSize, langEntries.length)}/${totalLangs}`);
                }

                allLanguagesData = allResults.filter(r => r && r.summary);

                if (allLanguagesData.length === 0) {
                    showNoResults();
                    return;
                }

                currentData = {
                    term: term,
                    wikidata: wikidataEntity,
                    langLinks: langLinks,
                    languages: allLanguagesData
                };

                displayWikidata(wikidataEntity);
                displayBasicResults(allLanguagesData);

                fullAnalysisBtn.classList.remove('hidden');
                updateProgress(100, '¬°Completado!');
                setTimeout(hideProgress, 500);

            } catch (error) {
                console.error('Search error:', error);
                showNoResults();
            } finally {
                setLoading(searchBtn, false);
            }
        }

        // ============ FULL ANALYSIS ============
        async function runFullAnalysis() {
            if (!currentData) return;

            setLoading(fullAnalysisBtn, true);
            showProgress();

            try {
                const langLinks = currentData.langLinks;
                const langEntries = Object.entries(langLinks);
                const totalLangs = langEntries.length;

                updateProgress(5, `Iniciando an√°lisis completo de ${totalLangs} idiomas...`);

                const batchSize = 5;
                const fullResults = [];

                for (let i = 0; i < langEntries.length; i += batchSize) {
                    const batch = langEntries.slice(i, i + batchSize);
                    const batchResults = await Promise.all(
                        batch.map(([lang, title]) => fetchFullArticle(lang, title))
                    );
                    fullResults.push(...batchResults);
                    const progress = 5 + Math.round((i / langEntries.length) * 85);
                    updateProgress(progress, `Analizando art√≠culos... ${Math.min(i + batchSize, langEntries.length)}/${totalLangs}`);
                }

                const validResults = fullResults.filter(r => r && r.sections && r.sections.length > 0);

                updateProgress(95, 'Unificando secciones...');

                fullAnalysisData = {
                    languages: validResults,
                    unified: unifyAllSections(validResults)
                };

                displayFullAnalysis(fullAnalysisData);

                updateProgress(100, '¬°An√°lisis completo!');
                setTimeout(hideProgress, 500);

            } catch (error) {
                console.error('Full analysis error:', error);
            } finally {
                setLoading(fullAnalysisBtn, false);
            }
        }

        // ============ FETCH FUNCTIONS ============
        async function searchWikipedia(term) {
            // Only search in allowed Western languages
            const tryLanguages = ['en', 'es', 'fr', 'de', 'it', 'pt', 'la', 'ca', 'nl', 'pl', 'el'];
            // Try multiple variations including common name patterns
            const variations = [
                term,
                term.toLowerCase(),
                titleCase(term),
                term.replace(/\s+/g, '_'),
                // Handle names like "tomas aquinas" -> "Thomas Aquinas"
                term.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ')
            ];

            for (const variant of variations) {
                for (const lang of tryLanguages) {
                    try {
                        const url = `https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(variant)}`;
                        const response = await fetch(url);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.extract) return { lang, title: data.title };
                        }
                    } catch (e) { continue; }
                }
            }
            return null;
        }

        async function getLanguageLinks(lang, title) {
            const url = `https://${lang}.wikipedia.org/w/api.php?` + new URLSearchParams({
                action: 'query', titles: title, prop: 'langlinks', lllimit: '500', format: 'json', origin: '*'
            });
            try {
                const response = await fetch(url);
                const data = await response.json();
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                const langlinks = pages[pageId]?.langlinks || [];
                const result = {};
                // Filter only allowed languages (Latin alphabet + Greek)
                langlinks.forEach(ll => {
                    if (isAllowedLanguage(ll.lang)) {
                        result[ll.lang] = ll['*'];
                    }
                });
                return result;
            } catch (error) { return {}; }
        }

        async function fetchSummary(lang, title) {
            try {
                const url = `https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
                const response = await fetch(url);
                if (!response.ok) return null;
                const data = await response.json();
                return {
                    lang, langName: getLanguageName(lang), title: data.title,
                    summary: data.extract || '',
                    url: data.content_urls?.desktop?.page || `https://${lang}.wikipedia.org/wiki/${encodeURIComponent(title)}`,
                    charCount: (data.extract || '').length
                };
            } catch (error) { return null; }
        }

        async function fetchFullArticle(lang, title) {
            try {
                // Get sections
                const sectionsUrl = `https://${lang}.wikipedia.org/w/api.php?` + new URLSearchParams({
                    action: 'parse', page: title, prop: 'sections', format: 'json', origin: '*'
                });
                const sectionsResp = await fetch(sectionsUrl);
                const sectionsData = await sectionsResp.json();

                if (sectionsData.error) return null;

                const sectionsList = sectionsData.parse?.sections || [];

                // Get full text content
                const contentUrl = `https://${lang}.wikipedia.org/w/api.php?` + new URLSearchParams({
                    action: 'query', titles: title, prop: 'extracts', explaintext: '1', format: 'json', origin: '*'
                });
                const contentResp = await fetch(contentUrl);
                const contentData = await contentResp.json();
                const pages = contentData.query?.pages || {};
                const pageId = Object.keys(pages)[0];
                const fullText = pages[pageId]?.extract || '';

                // Parse sections from full text
                const sections = parseFullTextIntoSections(fullText, sectionsList);

                return {
                    lang,
                    langName: getLanguageName(lang),
                    title,
                    sections,
                    totalChars: fullText.length,
                    url: `https://${lang}.wikipedia.org/wiki/${encodeURIComponent(title)}`
                };
            } catch (error) {
                console.error(`Error fetching ${lang}:${title}`, error);
                return null;
            }
        }

        function parseFullTextIntoSections(fullText, sectionsList) {
            const sections = [];
            const lines = fullText.split('\n');
            let currentSection = { title: 'Introducci√≥n', content: [], level: 0 };

            const sectionTitles = sectionsList.map(s => s.line.toLowerCase());

            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;

                // Check if this line is a section header
                const isHeader = sectionTitles.some(st =>
                    trimmed.toLowerCase() === st ||
                    trimmed.toLowerCase().startsWith(st + ' ')
                );

                if (isHeader && currentSection.content.length > 0) {
                    sections.push({
                        title: currentSection.title,
                        content: currentSection.content.join('\n\n'),
                        level: currentSection.level
                    });
                    currentSection = { title: trimmed, content: [], level: 1 };
                } else if (trimmed.length > 2) {
                    // Check for == Section == pattern
                    const headerMatch = trimmed.match(/^(={2,})\s*(.+?)\s*\1$/);
                    if (headerMatch) {
                        if (currentSection.content.length > 0) {
                            sections.push({
                                title: currentSection.title,
                                content: currentSection.content.join('\n\n'),
                                level: currentSection.level
                            });
                        }
                        currentSection = {
                            title: headerMatch[2],
                            content: [],
                            level: headerMatch[1].length - 1
                        };
                    } else {
                        currentSection.content.push(trimmed);
                    }
                }
            }

            // Add last section
            if (currentSection.content.length > 0) {
                sections.push({
                    title: currentSection.title,
                    content: currentSection.content.join('\n\n'),
                    level: currentSection.level
                });
            }

            return sections;
        }

        // ============ SECTION UNIFICATION ============
        function classifySection(sectionTitle) {
            const lower = sectionTitle.toLowerCase();

            for (const [category, keywords] of Object.entries(SECTION_KEYWORDS)) {
                for (const keyword of keywords) {
                    if (lower.includes(keyword)) {
                        return category;
                    }
                }
            }
            return 'other';
        }

        function unifyAllSections(languageResults) {
            const unified = {};

            for (const langData of languageResults) {
                for (const section of langData.sections) {
                    const category = classifySection(section.title);

                    if (!unified[category]) {
                        unified[category] = {
                            label: SECTION_LABELS[category] || category,
                            contents: []
                        };
                    }

                    unified[category].contents.push({
                        lang: langData.lang,
                        langName: langData.langName,
                        originalTitle: section.title,
                        content: section.content,
                        url: langData.url
                    });
                }
            }

            // Sort by number of languages contributing
            const sorted = Object.entries(unified)
                .sort((a, b) => b[1].contents.length - a[1].contents.length)
                .filter(([key]) => key !== 'references' && key !== 'see_also' && key !== 'external_links');

            return sorted;
        }

        // ============ WIKIDATA ============
        async function getWikidataId(lang, title) {
            const url = `https://${lang}.wikipedia.org/w/api.php?` + new URLSearchParams({
                action: 'query', titles: title, prop: 'pageprops', format: 'json', origin: '*'
            });
            try {
                const response = await fetch(url);
                const data = await response.json();
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                return pages[pageId]?.pageprops?.wikibase_item || null;
            } catch (error) { return null; }
        }

        async function getWikidataEntity(qid) {
            const url = `https://www.wikidata.org/w/api.php?` + new URLSearchParams({
                action: 'wbgetentities', ids: qid, props: 'labels|descriptions|claims', languages: 'es|en', format: 'json', origin: '*'
            });
            try {
                const response = await fetch(url);
                const data = await response.json();
                return data.entities?.[qid] || null;
            } catch (error) { return null; }
        }

        async function displayWikidata(entity) {
            if (!entity) {
                wikidataCard.classList.add('hidden');
                return;
            }

            const claims = entity.claims || {};
            const items = [];
            const idsToResolve = [];

            for (const [prop, config] of Object.entries(WIKIDATA_PROPS)) {
                if (claims[prop]) {
                    const value = extractWikidataValue(claims[prop]);
                    if (value) {
                        if (value.needsLabel) {
                            idsToResolve.push(value.id);
                            items.push({ prop, config, value: value.id, needsLabel: true });
                        } else {
                            items.push({ prop, config, value, needsLabel: false });
                        }
                    }
                }
            }

            const labels = await resolveWikidataLabels(idsToResolve);

            if (claims['P18']) {
                const imageName = extractWikidataValue(claims['P18']);
                if (imageName) {
                    entityImage.src = `https://commons.wikimedia.org/wiki/Special:FilePath/${encodeURIComponent(imageName.replace(/ /g, '_'))}?width=300`;
                    entityImage.classList.remove('hidden');
                }
            } else {
                entityImage.classList.add('hidden');
            }

            wikidataGrid.innerHTML = items
                .filter(item => item.prop !== 'P18')
                .map(item => {
                    const displayValue = item.needsLabel ? (labels[item.value] || item.value) : item.value;
                    return `
                        <div class="wikidata-item">
                            <div class="wikidata-icon">${item.config.icon}</div>
                            <div class="wikidata-content">
                                <div class="wikidata-label">${item.config.label}</div>
                                <div class="wikidata-value">${displayValue}</div>
                            </div>
                        </div>
                    `;
                }).join('');

            wikidataCard.classList.remove('hidden');
        }

        function extractWikidataValue(claim) {
            if (!claim || !claim[0]) return null;
            const mainsnak = claim[0].mainsnak;
            if (!mainsnak.datavalue) return null;
            const value = mainsnak.datavalue.value;
            const type = mainsnak.datavalue.type;

            switch (type) {
                case 'string': return value;
                case 'time': return formatWikidataDate(value.time);
                case 'wikibase-entityid': return { id: value.id, needsLabel: true };
                case 'quantity': return value.amount;
                case 'globecoordinate': return `${value.latitude.toFixed(4)}, ${value.longitude.toFixed(4)}`;
                default: return null;
            }
        }

        function formatWikidataDate(timeStr) {
            const match = timeStr.match(/([+-]?\d+)-(\d{2})-(\d{2})/);
            if (match) {
                const year = parseInt(match[1]);
                const month = parseInt(match[2]);
                const day = parseInt(match[3]);
                const months = ['', 'enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
                if (month === 0 && day === 0) return `${Math.abs(year)}${year < 0 ? ' a.C.' : ''}`;
                if (day === 0) return `${months[month]} ${Math.abs(year)}`;
                return `${day} ${months[month]} ${Math.abs(year)}`;
            }
            return timeStr;
        }

        async function resolveWikidataLabels(ids) {
            if (ids.length === 0) return {};
            const url = `https://www.wikidata.org/w/api.php?` + new URLSearchParams({
                action: 'wbgetentities', ids: ids.join('|'), props: 'labels', languages: 'es|en', format: 'json', origin: '*'
            });
            try {
                const response = await fetch(url);
                const data = await response.json();
                const labels = {};
                for (const [id, entity] of Object.entries(data.entities || {})) {
                    labels[id] = entity.labels?.es?.value || entity.labels?.en?.value || id;
                }
                return labels;
            } catch (error) { return {}; }
        }

        // ============ DISPLAY FUNCTIONS ============
        function displayBasicResults(languages) {
            langCountBadge.textContent = languages.length;

            languagesList.innerHTML = languages.map((lang, index) => `
                <div class="language-item" data-index="${index}">
                    <div class="language-header" onclick="toggleLanguageItem(${index})">
                        <div class="expand-icon">‚ñº</div>
                        <span class="lang-code">${lang.lang}</span>
                        <div class="lang-info">
                            <div class="lang-name">${lang.langName}</div>
                            <div class="lang-title">${lang.title}</div>
                        </div>
                        <span class="section-count">${formatNumber(lang.charCount)} chars</span>
                    </div>
                    <div class="language-content">
                        <p class="section-text">${lang.summary}</p>
                        <div style="margin-top: 15px;">
                            <a href="${lang.url}" target="_blank" class="action-btn">üîó Ver en Wikipedia</a>
                        </div>
                    </div>
                </div>
            `).join('');

            resultsCard.classList.remove('hidden');
            switchTab('by-language');
        }

        function displayFullAnalysis(data) {
            const { languages, unified } = data;

            // Stats
            const totalChars = languages.reduce((sum, l) => sum + l.totalChars, 0);
            const uniqueSections = unified.length;

            document.getElementById('statLanguages').textContent = languages.length;
            document.getElementById('statSections').textContent = uniqueSections;
            document.getElementById('statChars').textContent = formatNumber(totalChars);
            statsBar.classList.remove('hidden');

            // Unified view
            unifiedContent.innerHTML = unified.map(([category, data], index) => `
                <div class="unified-section ${index < 3 ? 'expanded' : ''}" data-category="${category}">
                    <div class="unified-section-header" onclick="toggleUnifiedSection('${category}')">
                        <h3>
                            ${data.label}
                            <span style="font-weight: normal; font-size: 0.85rem; opacity: 0.8;">(${data.contents.length} idiomas)</span>
                        </h3>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="lang-badges">
                                ${data.contents.slice(0, 5).map(c => `<span class="lang-badge">${c.lang}</span>`).join('')}
                                ${data.contents.length > 5 ? `<span class="lang-badge">+${data.contents.length - 5}</span>` : ''}
                            </div>
                            <span class="expand-indicator">‚ñº</span>
                        </div>
                    </div>
                    <div class="unified-section-content">
                        ${data.contents.map(content => `
                            <div class="lang-content-item">
                                <div class="lang-content-header">
                                    <span class="lang-flag">${content.lang}</span>
                                    <span class="lang-content-title">${content.langName} - ${content.originalTitle}</span>
                                </div>
                                <div class="lang-content-text">
                                    ${content.content.split('\n').map(p => `<p>${p}</p>`).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            // By language view with sections
            languagesList.innerHTML = languages.map((lang, index) => `
                <div class="language-item" data-index="${index}">
                    <div class="language-header" onclick="toggleLanguageItem(${index})">
                        <div class="expand-icon">‚ñº</div>
                        <span class="lang-code">${lang.lang}</span>
                        <div class="lang-info">
                            <div class="lang-name">${lang.langName}</div>
                            <div class="lang-title">${lang.title}</div>
                        </div>
                        <span class="section-count">${lang.sections.length} secciones</span>
                    </div>
                    <div class="language-content">
                        ${lang.sections.map(section => `
                            <div class="section-item">
                                <div class="section-title">
                                    ${SECTION_LABELS[classifySection(section.title)] ? SECTION_LABELS[classifySection(section.title)].split(' ')[0] : 'üìÑ'}
                                    ${section.title}
                                </div>
                                <div class="section-text">${section.content.substring(0, 1000)}${section.content.length > 1000 ? '...' : ''}</div>
                            </div>
                        `).join('')}
                        <div style="margin-top: 15px;">
                            <a href="${lang.url}" target="_blank" class="action-btn">üîó Ver art√≠culo completo</a>
                        </div>
                    </div>
                </div>
            `).join('');

            switchTab('unified');
        }

        // ============ UI HELPERS ============
        function toggleLanguageItem(index) {
            const item = document.querySelector(`.language-item[data-index="${index}"]`);
            item.classList.toggle('expanded');
        }

        function toggleUnifiedSection(category) {
            const section = document.querySelector(`.unified-section[data-category="${category}"]`);
            section.classList.toggle('expanded');
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`${tabId === 'unified' ? 'unifiedTab' : 'byLanguageTab'}`).classList.add('active');
        }

        function expandAll() {
            document.querySelectorAll('.language-item, .unified-section').forEach(item => item.classList.add('expanded'));
        }

        function collapseAll() {
            document.querySelectorAll('.language-item, .unified-section').forEach(item => item.classList.remove('expanded'));
        }

        function copyAllContent() {
            if (!fullAnalysisData && !currentData) return;

            let content = `# ${currentData.term}\n\n`;

            if (fullAnalysisData) {
                content += `## An√°lisis Completo\n\n`;
                content += `- Idiomas: ${fullAnalysisData.languages.length}\n`;
                content += `- Secciones √∫nicas: ${fullAnalysisData.unified.length}\n\n`;

                for (const [category, data] of fullAnalysisData.unified) {
                    content += `## ${data.label}\n\n`;
                    for (const item of data.contents) {
                        content += `### ${item.langName} (${item.lang})\n`;
                        content += `*${item.originalTitle}*\n\n`;
                        content += `${item.content}\n\n`;
                    }
                    content += `---\n\n`;
                }
            } else {
                for (const lang of currentData.languages) {
                    content += `## ${lang.langName} (${lang.lang})\n`;
                    content += `**${lang.title}**\n\n`;
                    content += `${lang.summary}\n\n---\n\n`;
                }
            }

            navigator.clipboard.writeText(content).then(() => {
                showCopyNotification('‚úì Copiado al portapapeles');
            });
        }

        // ============ UTILITIES ============
        function getLanguageName(code) {
            const names = {
                'en': 'English', 'es': 'Espa√±ol', 'fr': 'Fran√ßais', 'de': 'Deutsch',
                'it': 'Italiano', 'pt': 'Portugu√™s', 'nl': 'Nederlands',
                'pl': 'Polski', 'sv': 'Svenska', 'da': 'Dansk', 'no': 'Norsk', 'fi': 'Suomi',
                'ca': 'Catal√†', 'gl': 'Galego', 'ro': 'Rom√¢nƒÉ', 'oc': 'Occitan',
                'eu': 'Euskara', 'la': 'Latina', 'el': 'ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨',
                'cs': 'ƒåe≈°tina', 'sk': 'Slovenƒçina', 'sl': 'Sloven≈°ƒçina',
                'hr': 'Hrvatski', 'bs': 'Bosanski', 'sq': 'Shqip',
                'hu': 'Magyar', 'et': 'Eesti', 'lt': 'Lietuvi≈≥', 'lv': 'Latvie≈°u',
                'is': '√çslenska', 'ga': 'Gaeilge', 'cy': 'Cymraeg', 'gd': 'G√†idhlig',
                'br': 'Brezhoneg', 'af': 'Afrikaans', 'mt': 'Malti',
                'tr': 'T√ºrk√ße', 'az': 'Az…ôrbaycan', 'id': 'Bahasa Indonesia',
                'ms': 'Bahasa Melayu', 'sw': 'Kiswahili', 'tl': 'Tagalog',
                'vi': 'Ti·∫øng Vi·ªát', 'eo': 'Esperanto', 'simple': 'Simple English',
                'lb': 'L√´tzebuergesch', 'fy': 'Frysk', 'nn': 'Nynorsk',
                'nds': 'Plattd√º√ºtsch', 'als': 'Alemannisch', 'bar': 'Boarisch',
                'an': 'Aragon√©s', 'ast': 'Asturianu', 'ext': 'Extreme√±u',
                'nap': 'Napulitano', 'scn': 'Sicilianu', 'vec': 'V√®neto',
                'lmo': 'Lombard', 'pms': 'Piemont√®is', 'fur': 'Furlan',
                'lij': 'Ligure', 'sc': 'Sardu', 'wa': 'Walon', 'rm': 'Rumantsch',
                'sco': 'Scots', 'gv': 'Gaelg', 'kw': 'Kernowek',
                'ceb': 'Cebuano', 'io': 'Ido', 'ia': 'Interlingua', 'vo': 'Volap√ºk'
            };
            return names[code] || code.toUpperCase();
        }

        function titleCase(str) {
            return str.replace(/\w\S*/g, txt => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
        }

        function formatNumber(num) {
            return num.toLocaleString();
        }

        function setLoading(btn, loading) {
            btn.disabled = loading;
            btn.classList.toggle('loading', loading);
        }

        function showProgress() {
            progressSection.classList.add('visible');
        }

        function hideProgress() {
            progressSection.classList.remove('visible');
        }

        function updateProgress(percent, text) {
            progressFill.style.width = `${percent}%`;
            progressText.textContent = text;
        }

        function hideAllCards() {
            wikidataCard.classList.add('hidden');
            resultsCard.classList.add('hidden');
            noResultsCard.classList.add('hidden');
            statsBar.classList.add('hidden');
        }

        function showNoResults() {
            noResultsCard.classList.remove('hidden');
            hideProgress();
            setLoading(searchBtn, false);
        }

        function showCopyNotification(text) {
            copyNotification.textContent = text;
            copyNotification.classList.add('visible');
            setTimeout(() => copyNotification.classList.remove('visible'), 2000);
        }

        // ============ EVENT LISTENERS ============
        searchBtn.addEventListener('click', search);
        fullAnalysisBtn.addEventListener('click', runFullAnalysis);
        searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') search(); });

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => switchTab(tab.dataset.tab));
        });

        document.getElementById('expandAllBtn').addEventListener('click', expandAll);
        document.getElementById('collapseAllBtn').addEventListener('click', collapseAll);
        document.getElementById('copyAllBtn').addEventListener('click', copyAllContent);

        sortSelect.addEventListener('change', () => {
            if (!fullAnalysisData) return;
            const languages = [...fullAnalysisData.languages];
            const sortBy = sortSelect.value;

            switch (sortBy) {
                case 'sections-desc': languages.sort((a, b) => b.sections.length - a.sections.length); break;
                case 'length-desc': languages.sort((a, b) => b.totalChars - a.totalChars); break;
                case 'alpha': languages.sort((a, b) => a.langName.localeCompare(b.langName)); break;
            }

            fullAnalysisData.languages = languages;
            displayFullAnalysis(fullAnalysisData);
        });

        filterInput.addEventListener('input', () => {
            const filter = filterInput.value.toLowerCase();
            document.querySelectorAll('.language-item').forEach(item => {
                const name = item.querySelector('.lang-name')?.textContent.toLowerCase() || '';
                const code = item.querySelector('.lang-code')?.textContent.toLowerCase() || '';
                item.style.display = (name.includes(filter) || code.includes(filter)) ? '' : 'none';
            });
        });

        searchInput.focus();
    </script>
</body>
</html>
